---
# This workflow runs all of the compiler tests

name: Compiler Tests

on:
  # Runs every Friday from 7AM UTC
    schedule:
        - cron: 00 7 * * 5
  # Allows us to manually start workflow for testing
    workflow_dispatch:
    push:
      branches: '*'

jobs:
  # replication of compiler-tests.sh
    all-compilers:
        strategy:
            fail-fast: false
            matrix:
                image: [gcc-version-12]
                opts: [.fast]
        runs-on: [ubuntu-latest]
        timeout-minutes: 2880 # 48 hours
        container: ghcr.io/gem5/${{ matrix.image }}:latest
        steps:
            - uses: actions/checkout@v3
              #              with:
              #        # Scheduled workflows run on the default branch by default. We
              #        # therefore need to explicitly checkout the develop branch.
              #                  ref: develop

            - name: ccache
              uses: hendrikmuhs/ccache-action@v1.2
              with:
                key: ${{ matrix.image }}-${{ matrix.opts }}-ccache-${{ github.ref_name }}
                restore-keys: |
                  ${{ matrix.image }}-${{ matrix.opts }}-ccache-master
                  ${{ matrix.image }}-${{ matrix.opts }}-ccache

            - name: Compile build/ALL/gem5${{ matrix.opts }} with ${{ matrix.image }}
              run: /usr/bin/env python3 /usr/bin/scons --ignore-style build/ALL/gem5${{ matrix.opts }} -j$(nproc)
              timeout-minutes: 600 # 10 hours

  # Tests the two latest gcc and clang supported compilers against all gem5 compilations.
    latest-compilers-all-gem5-builds:
        strategy:
            fail-fast: false
            matrix:
                gem5-compilation: [RISCV]
                image: [gcc-version-12]
                opts: [.opt]
        runs-on: [ubuntu-latest]
        timeout-minutes: 2880 # 48 hours
        container: ghcr.io/gem5/${{ matrix.image }}:latest
        steps:
            - uses: actions/checkout@v3
              #              with:
              #        # Scheduled workflows run on the default branch by default. We
              #        # therefore need to explicitly checkout the develop branch.
              #                  ref: develop

            - name: ccache
              uses: hendrikmuhs/ccache-action@v1.2
              with:
                key: ${{ matrix.image }}-${{ matrix.opts }}-${{ matrix.gem-compilation }}-ccache-${{ github.ref_name }}
                restore-keys: |
                  ${{ matrix.image }}-${{ matrix.opts }}-${{ matrix.gem-compilation }}-ccache-master
                  ${{ matrix.image }}-${{ matrix.opts }}-${{ matrix.gem-compilation }}-ccache

            - name: Compile build/${{ matrix.gem5-compilation }}/gem5${{ matrix.opts }} with ${{ matrix.image }}
              run: /usr/bin/env python3 /usr/bin/scons --ignore-style build/${{ matrix.gem5-compilation }}/gem5${{ matrix.opts }} -j$(nproc)
              timeout-minutes: 600 # 10 hours

    compiler-tests:
        # The dummy job is used to indicate whether the compiler tests have
        # passed or not. This can be used as status check for pull requests.
        # I.e., if we want to stop pull requests from being merged if the
        # compiler tests are failing, we can add this job as a required status
        # check.
        runs-on: ubuntu-22.04
        needs:
            - latest-compilers-all-gem5-builds
            - all-compilers
        steps:
            - run: echo "This compiler tests have passed."
